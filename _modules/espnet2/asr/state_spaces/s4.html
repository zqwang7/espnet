<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>espnet2.asr.state_spaces.s4 &mdash; ESPnet 202308 documentation</title><link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/nbsphinx-code-cells.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/nbsphinx-code-cells.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/nbsphinx-code-cells.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/nbsphinx-code-cells.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/nbsphinx-code-cells.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/nbsphinx-code-cells.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/nbsphinx-code-cells.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/nbsphinx-code-cells.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/nbsphinx-code-cells.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/nbsphinx-code-cells.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/nbsphinx-code-cells.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/nbsphinx-code-cells.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/nbsphinx-code-cells.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/nbsphinx-code-cells.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/nbsphinx-code-cells.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/nbsphinx-code-cells.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/nbsphinx-code-cells.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/nbsphinx-code-cells.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/nbsphinx-code-cells.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/nbsphinx-code-cells.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/nbsphinx-code-cells.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "tex2jax_ignore|mathjax_ignore|document", "processClass": "tex2jax_process|mathjax_process|math|output_area"}})</script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            ESPnet
          </a>
              <div class="version">
                202308
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p><span class="caption-text">Tutorial:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial.html">Common usages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../parallelization.html">Using job scheduling system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docker.html">Docker</a></li>
</ul>
<p><span class="caption-text">ESPnet1:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../espnet1_tutorial.html">Usage</a></li>
</ul>
<p><span class="caption-text">ESPnet2:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../espnet2_tutorial.html">ESPnet2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../espnet2_tutorial.html#instruction-for-run-sh">Instruction for run.sh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../espnet2_training_option.html">Change the configuration for training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../espnet2_format_wav_scp.html">Converting audio file formats using format_wav_scp.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../espnet2_task.html">Task class and data input system for training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../espnet2_distributed.html">Distributed training</a></li>
</ul>
<p><span class="caption-text">Notebook:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/DataPreparation_CMU_11492_692_Spring2023(Assignment0).html">CMU 11492/11692 Spring 2023: Data preparation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/DataPreparation_CMU_11492_692_Spring2023(Assignment0).html#Data-preparation-in-ESPnet">Data preparation in ESPnet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/SpeechEnhancement_CMU_11492_692_Spring2023(Assignment7).html">CMU 11492/11692 Spring 2023: Speech Enhancement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/SpeechEnhancement_CMU_11492_692_Spring2023(Assignment7).html#Contents">Contents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/SpokenLanguageUnderstanding_CMU_11492_692_Spring2023(Assignment6).html">CMU 11492/11692 Spring 2023: Spoken Language Understanding</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/TextToSpeech_CMU_11492_692_Spring2023(Assignment8).html">CMU 11492/11692 Spring 2023: Text to Speech</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/asr_cli.html">Speech Recognition (Recipe)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/asr_library.html">Speech Recognition (Library)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/espnet2_2pass_slu_demo.html">ESPNET 2 pass SLU Demonstration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/espnet2_asr_realtime_demo.html">ESPnet2-ASR realtime demonstration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/espnet2_asr_transfer_learning_demo.html"><strong>Use transfer learning for ASR in ESPnet2</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/espnet2_asr_transfer_learning_demo.html#Abstract">Abstract</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/espnet2_asr_transfer_learning_demo.html#ESPnet-installation-(about-10-minutes-in-total)">ESPnet installation (about 10 minutes in total)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/espnet2_asr_transfer_learning_demo.html#mini_an4-recipe-as-a-transfer-learning-example">mini_an4 recipe as a transfer learning example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/espnet2_new_task_tutorial_CMU_11751_18781_Fall2022.html">CMU 11751/18781 Fall 2022: ESPnet Tutorial2 (New task)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/espnet2_new_task_tutorial_CMU_11751_18781_Fall2022.html#Install-ESPnet-(Almost-same-procedure-as-your-first-tutorial)">Install ESPnet (Almost same procedure as your first tutorial)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/espnet2_new_task_tutorial_CMU_11751_18781_Fall2022.html#What-we-provide-you-and-what-you-need-to-proceed">What we provide you and what you need to proceed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/espnet2_recipe_tutorial_CMU_11751_18781_Fall2022.html">CMU 11751/18781 Fall 2022: ESPnet Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/espnet2_recipe_tutorial_CMU_11751_18781_Fall2022.html#Install-ESPnet">Install ESPnet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/espnet2_recipe_tutorial_CMU_11751_18781_Fall2022.html#Run-an-existing-recipe">Run an existing recipe</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/espnet2_recipe_tutorial_CMU_11751_18781_Fall2022.html#Make-a-new-recipe">Make a new recipe</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/espnet2_recipe_tutorial_CMU_11751_18781_Fall2022.html#Additional-resources">Additional resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/espnet2_streaming_asr_demo.html">ESPnet2 real streaming Transformer demonstration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/espnet2_tts_realtime_demo.html">ESPnet2-TTS realtime demonstration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/espnet2_tutorial_2021_CMU_11751_18781.html">CMU 11751/18781 2021: ESPnet Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/espnet2_tutorial_2021_CMU_11751_18781.html#Run-an-inference-example">Run an inference example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/espnet2_tutorial_2021_CMU_11751_18781.html#Full-installation">Full installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/espnet2_tutorial_2021_CMU_11751_18781.html#Run-a-recipe-example">Run a recipe example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/espnet_se_demonstration_for_waspaa_2021.html">ESPnet Speech Enhancement Demonstration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/espnet_se_demonstration_for_waspaa_2021.html#Contents">Contents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/espnet_se_demonstration_for_waspaa_2021.html#(1)-Tutorials-on-the-Basic-Usage">(1) Tutorials on the Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/espnet_se_demonstration_for_waspaa_2021.html#(2)-Tutorials-on-Contributing-to-ESPNet-SE-Project">(2) Tutorials on Contributing to ESPNet-SE Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/onnx_conversion_demo.html">espnet_onnx demonstration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/onnx_conversion_demo.html#Install-Dependency">Install Dependency</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/onnx_conversion_demo.html#Export-your-model">Export your model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/onnx_conversion_demo.html#Inference-with-onnx">Inference with onnx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/onnx_conversion_demo.html#Using-streaming-model">Using streaming model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/pretrained.html">Pretrained Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/se_demo.html">ESPnet Speech Enhancement Demonstration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/st_demo.html">ESPnet Speech Translation Demonstration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/tts_cli.html">Text-to-Speech (Recipe)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebook/tts_realtime_demo.html">ESPnet real time E2E-TTS demonstration</a></li>
</ul>
<p><span class="caption-text">Package Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet.distributed.html">espnet.distributed package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet.tts.html">espnet.tts package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet.asr.html">espnet.asr package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet.st.html">espnet.st package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet.transform.html">espnet.transform package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet.bin.html">espnet.bin package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet.optimizer.html">espnet.optimizer package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet.nets.html">espnet.nets package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet.scheduler.html">espnet.scheduler package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet.vc.html">espnet.vc package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet.mt.html">espnet.mt package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet.lm.html">espnet.lm package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet.utils.html">espnet.utils package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.svs.html">espnet2.svs package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.tts.html">espnet2.tts package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.asr.html">espnet2.asr package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.asr_transducer.html">espnet2.asr_transducer package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.st.html">espnet2.st package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.bin.html">espnet2.bin package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.asvspoof.html">espnet2.asvspoof package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.schedulers.html">espnet2.schedulers package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.gan_svs.html">espnet2.gan_svs package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.fileio.html">espnet2.fileio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.slu.html">espnet2.slu package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.hubert.html">espnet2.hubert package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.gan_tts.html">espnet2.gan_tts package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.optimizers.html">espnet2.optimizers package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.uasr.html">espnet2.uasr package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.spk.html">espnet2.spk package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.enh.html">espnet2.enh package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.train.html">espnet2.train package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.main_funcs.html">espnet2.main_funcs package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.samplers.html">espnet2.samplers package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.mt.html">espnet2.mt package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.fst.html">espnet2.fst package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.lm.html">espnet2.lm package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.layers.html">espnet2.layers package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.utils.html">espnet2.utils package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.tasks.html">espnet2.tasks package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.iterators.html">espnet2.iterators package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.text.html">espnet2.text package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.torch_utils.html">espnet2.torch_utils package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_gen/espnet2.diar.html">espnet2.diar package</a></li>
</ul>
<p><span class="caption-text">Tool Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../apis/espnet_bin.html">core tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apis/espnet2_bin.html">core tools (espnet2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apis/utils_py.html">python utility tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apis/utils_sh.html">bash utility tools</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">ESPnet</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">espnet2.asr.state_spaces.s4</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for espnet2.asr.state_spaces.s4</h1><div class="highlight"><pre>
<span></span><span class="c1"># This code is derived from https://github.com/HazyResearch/state-spaces</span>

<span class="sd">&quot;&quot;&quot;Standalone version of Structured (Sequence) State Space (S4) model.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="c1"># from pytorch_lightning.utilities import rank_zero_only</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">opt_einsum</span> <span class="k">as</span> <span class="nn">oe</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">einops</span> <span class="kn">import</span> <span class="n">rearrange</span><span class="p">,</span> <span class="n">repeat</span>

<span class="kn">from</span> <span class="nn">espnet2.asr.state_spaces.components</span> <span class="kn">import</span> <span class="n">Activation</span><span class="p">,</span> <span class="n">DropoutNd</span><span class="p">,</span> <span class="n">LinearActivation</span>

<span class="n">contract</span> <span class="o">=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract</span>
<span class="n">contract_expression</span> <span class="o">=</span> <span class="n">oe</span><span class="o">.</span><span class="n">contract_expression</span>


<div class="viewcode-block" id="rank_zero_only"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.rank_zero_only">[docs]</a><span class="k">def</span> <span class="nf">rank_zero_only</span><span class="p">(</span><span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator function from PyTorch Lightning.</span>

<span class="sd">    Function that can be used as a decorator</span>
<span class="sd">    to enable a function/method being called only on global rank 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapped_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">rank_zero_only</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">wrapped_fn</span></div>


<span class="k">def</span> <span class="nf">_get_rank</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="c1"># SLURM_PROCID can be set even if SLURM is not managing the multiprocessing,</span>
    <span class="c1"># therefore LOCAL_RANK needs to be checked first</span>
    <span class="n">rank_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;RANK&quot;</span><span class="p">,</span> <span class="s2">&quot;LOCAL_RANK&quot;</span><span class="p">,</span> <span class="s2">&quot;SLURM_PROCID&quot;</span><span class="p">,</span> <span class="s2">&quot;JSM_NAMESPACE_RANK&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">rank_keys</span><span class="p">:</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>


<span class="c1"># add the attribute to the function but don&#39;t overwrite</span>
<span class="c1"># in case Trainer has already set it</span>
<span class="n">rank_zero_only</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rank_zero_only</span><span class="p">,</span> <span class="s2">&quot;rank&quot;</span><span class="p">,</span> <span class="n">_get_rank</span><span class="p">())</span>


<div class="viewcode-block" id="get_logger"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.get_logger">[docs]</a><span class="k">def</span> <span class="nf">get_logger</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize multi-GPU-friendly python logger.&quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

    <span class="c1"># this ensures all logging levels get marked with the rank zero decorator</span>
    <span class="c1"># otherwise logs would get multiplied for each GPU process in multi-GPU setup</span>
    <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="s2">&quot;debug&quot;</span><span class="p">,</span>
        <span class="s2">&quot;info&quot;</span><span class="p">,</span>
        <span class="s2">&quot;warning&quot;</span><span class="p">,</span>
        <span class="s2">&quot;error&quot;</span><span class="p">,</span>
        <span class="s2">&quot;exception&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fatal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;critical&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">rank_zero_only</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">level</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">logger</span></div>


<span class="n">log</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot; Cauchy and Vandermonde kernels &quot;&quot;&quot;</span>

<span class="k">try</span><span class="p">:</span>  <span class="c1"># Try CUDA extension</span>
    <span class="kn">from</span> <span class="nn">.cauchy</span> <span class="kn">import</span> <span class="n">cauchy_mult</span>

    <span class="n">has_cauchy_extension</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
        <span class="s2">&quot;CUDA extension for cauchy multiplication not found.&quot;</span>
        <span class="s2">&quot; Please install it via `cd /path/to/espnet/tools &amp;&amp; . ./activate_python.sh&quot;</span>
        <span class="s2">&quot; &amp;&amp; ./installers/install_cauchy_mult.sh`.&quot;</span>
        <span class="s2">&quot; This should speed up end-to-end training by 10-50%&quot;</span>
    <span class="p">)</span>
    <span class="n">has_cauchy_extension</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">try</span><span class="p">:</span>  <span class="c1"># Try pykeops</span>
    <span class="kn">import</span> <span class="nn">pykeops</span>  <span class="c1"># noqa</span>
    <span class="kn">from</span> <span class="nn">pykeops.torch</span> <span class="kn">import</span> <span class="n">Genred</span>

    <span class="n">has_pykeops</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Pykeops installation found.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_broadcast_dims</span><span class="p">(</span><span class="o">*</span><span class="n">tensors</span><span class="p">):</span>
        <span class="n">max_dim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">tensor</span> <span class="ow">in</span> <span class="n">tensors</span><span class="p">])</span>
        <span class="n">tensors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">tensor</span><span class="o">.</span><span class="n">view</span><span class="p">((</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_dim</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span> <span class="o">+</span> <span class="n">tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tensor</span> <span class="ow">in</span> <span class="n">tensors</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">tensors</span>

    <span class="k">def</span> <span class="nf">cauchy_conj</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pykeops version.&quot;&quot;&quot;</span>
        <span class="n">expr_num</span> <span class="o">=</span> <span class="s2">&quot;z * ComplexReal(v) - Real2Complex(Sum(v * w))&quot;</span>
        <span class="n">expr_denom</span> <span class="o">=</span> <span class="s2">&quot;ComplexMult(z-w, z-Conj(w))&quot;</span>

        <span class="n">cauchy_mult</span> <span class="o">=</span> <span class="n">Genred</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ComplexDivide(</span><span class="si">{</span><span class="n">expr_num</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">expr_denom</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="s2">&quot;v = Vj(2)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;z = Vi(2)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;w = Vj(2)&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">reduction_op</span><span class="o">=</span><span class="s2">&quot;Sum&quot;</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">v</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">_broadcast_dims</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">_c2r</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">_c2r</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">_c2r</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">cauchy_mult</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;GPU&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_r2c</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">log_vandermonde</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="s2">&quot;ComplexMult(v, ComplexExp(ComplexMult(x, l)))&quot;</span>
        <span class="n">vandermonde_mult</span> <span class="o">=</span> <span class="n">Genred</span><span class="p">(</span>
            <span class="n">expr</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="s2">&quot;v = Vj(2)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;x = Vj(2)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;l = Vi(2)&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">reduction_op</span><span class="o">=</span><span class="s2">&quot;Sum&quot;</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">length</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">L</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">v</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">_broadcast_dims</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">_c2r</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">_c2r</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">length</span> <span class="o">=</span> <span class="n">_c2r</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">vandermonde_mult</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;GPU&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">_r2c</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>

    <span class="k">def</span> <span class="nf">log_vandermonde_transpose</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute Vandermonde product.</span>

<span class="sd">        u: ... H L</span>
<span class="sd">        v: ... H N</span>
<span class="sd">        x: ... H N</span>
<span class="sd">        Returns: ... H N</span>

<span class="sd">        V = Vandermonde(a, L) : (H N L)</span>
<span class="sd">        contract_L(V * u * v)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="s2">&quot;ComplexMult(ComplexMult(v, u), ComplexExp(ComplexMult(x, l)))&quot;</span>
        <span class="n">vandermonde_mult</span> <span class="o">=</span> <span class="n">Genred</span><span class="p">(</span>
            <span class="n">expr</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="s2">&quot;u = Vj(2)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;v = Vi(2)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;x = Vi(2)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;l = Vj(2)&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">reduction_op</span><span class="o">=</span><span class="s2">&quot;Sum&quot;</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">length</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">L</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">_broadcast_dims</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">_c2r</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">_c2r</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">_c2r</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">length</span> <span class="o">=</span> <span class="n">_c2r</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">vandermonde_mult</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;GPU&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_r2c</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">has_pykeops</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_cauchy_extension</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Falling back on slow Cauchy kernel. &quot;</span>
            <span class="s2">&quot;Install at least one of pykeops or the CUDA extension for efficiency.&quot;</span>
        <span class="p">)</span>

<div class="viewcode-block" id="cauchy_naive"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.cauchy_naive">[docs]</a>        <span class="k">def</span> <span class="nf">cauchy_naive</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Naive version.</span>

<span class="sd">            v, w: (..., N)</span>
<span class="sd">            z: (..., L)</span>
<span class="sd">            returns: (..., L)</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">cauchy_matrix</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                <span class="n">z</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">w</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># (... N L)</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cauchy_matrix</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span></div>

    <span class="c1"># Vandermonde functions</span>
    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
        <span class="s2">&quot;Falling back on slow Vandermonde kernel. &quot;</span>
        <span class="s2">&quot;Install pykeops for improved memory efficiency.&quot;</span>
    <span class="p">)</span>

<div class="viewcode-block" id="log_vandermonde"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.log_vandermonde">[docs]</a>    <span class="k">def</span> <span class="nf">log_vandermonde</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Compute Vandermonde product.</span>

<span class="sd">        v: (..., N)</span>
<span class="sd">        x: (..., N)</span>
<span class="sd">        returns: (..., L) \sum v x^l</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vandermonde_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">L</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># (... N L)</span>
        <span class="n">vandermonde_prod</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span>
            <span class="s2">&quot;... n, ... n l -&gt; ... l&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">vandermonde_matrix</span>
        <span class="p">)</span>  <span class="c1"># (... L)</span>
        <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">vandermonde_prod</span><span class="o">.</span><span class="n">real</span></div>

<div class="viewcode-block" id="log_vandermonde_transpose"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.log_vandermonde_transpose">[docs]</a>    <span class="k">def</span> <span class="nf">log_vandermonde_transpose</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span>
        <span class="n">vandermonde_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">L</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># (... N L)</span>
        <span class="n">vandermonde_prod</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span>
            <span class="s2">&quot;... l, ... n, ... n l -&gt; ... n&quot;</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">vandermonde_matrix</span>
        <span class="p">)</span>  <span class="c1"># (... L)</span>
        <span class="k">return</span> <span class="n">vandermonde_prod</span></div>


<span class="k">def</span> <span class="nf">_conj</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">conj</span><span class="p">()],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>


<span class="n">_c2r</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_real</span>
<span class="n">_r2c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">view_as_complex</span>
<span class="k">if</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">__version__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]))</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_resolve_conj</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">resolve_conj</span><span class="p">()</span>

<span class="k">else</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">_resolve_conj</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>


<span class="sd">&quot;&quot;&quot; Misc functional utilities &quot;&quot;&quot;</span>


<div class="viewcode-block" id="power"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.power">[docs]</a><span class="k">def</span> <span class="nf">power</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute A^L and the scan sum_i A^i v_i.</span>

<span class="sd">    A: (..., N, N)</span>
<span class="sd">    v: (..., N, L)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>  <span class="c1"># , dtype=A.dtype, device=A.device)</span>

    <span class="n">powers</span> <span class="o">=</span> <span class="p">[</span><span class="n">A</span><span class="p">]</span>
    <span class="n">length</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">L</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">powers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">E</span>
        <span class="n">L</span> <span class="o">//=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">L</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">length</span> <span class="o">*=</span> <span class="mi">2</span>
        <span class="n">powers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">powers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">powers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">E</span>

    <span class="c1"># Invariants:</span>
    <span class="c1"># powers[-1] := A^length</span>
    <span class="c1"># length := largest po2 at most L</span>

    <span class="c1"># Note that an alternative divide and conquer to compute the reduction is possible</span>
    <span class="c1"># and can be embedded into the above loop without caching intermediate powers of A</span>
    <span class="c1"># We do this reverse divide-and-conquer for efficiency reasons:</span>
    <span class="c1"># 1) it involves fewer padding steps for non-po2 L</span>
    <span class="c1"># 2) it involves more contiguous arrays</span>

    <span class="c1"># Take care of edge case for non-po2 arrays</span>
    <span class="c1"># Note that this initial step is a no-op for the case of power of 2 (length == L)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">length</span>
    <span class="n">v_</span> <span class="o">=</span> <span class="n">powers</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="o">@</span> <span class="n">v</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">length</span><span class="p">:]</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">length</span><span class="p">]</span>
    <span class="n">v</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">v_</span>

    <span class="c1"># Handle reduction for power of 2</span>
    <span class="k">while</span> <span class="n">v</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">rearrange</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;... (z l) -&gt; ... z l&quot;</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">powers</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="o">@</span> <span class="n">v</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">E</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>


<span class="sd">&quot;&quot;&quot; HiPPO utilities &quot;&quot;&quot;</span>


<div class="viewcode-block" id="transition"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.transition">[docs]</a><span class="k">def</span> <span class="nf">transition</span><span class="p">(</span><span class="n">measure</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A, B transition matrices for different measures.&quot;&quot;&quot;</span>
    <span class="c1"># Legendre (translated)</span>
    <span class="k">if</span> <span class="n">measure</span> <span class="o">==</span> <span class="s2">&quot;legt&quot;</span><span class="p">:</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">R</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Q</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">R</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">R</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">R</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">A</span> <span class="o">=</span> <span class="o">-</span><span class="n">A</span>

        <span class="c1"># Halve again for timescale correctness</span>
        <span class="n">A</span> <span class="o">*=</span> <span class="mf">0.5</span>
        <span class="n">B</span> <span class="o">*=</span> <span class="mf">0.5</span>
    <span class="c1"># Legendre (scaled)</span>
    <span class="k">elif</span> <span class="n">measure</span> <span class="o">==</span> <span class="s2">&quot;legs&quot;</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">col</span><span class="p">,</span> <span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">M</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">row</span> <span class="o">&gt;=</span> <span class="n">col</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">M</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">T</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Otherwise &quot;UserWarning: given NumPY array is not writeable...&quot;</span>
        <span class="c1"># after torch.as_tensor(B)</span>
    <span class="k">elif</span> <span class="n">measure</span> <span class="o">==</span> <span class="s2">&quot;legsd&quot;</span><span class="p">:</span>
        <span class="c1"># Essentially equivalent to S4D-LegS</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">col</span><span class="p">,</span> <span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">M</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">row</span> <span class="o">&gt;=</span> <span class="n">col</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="n">M</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">T</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Otherwise &quot;UserWarning: given NumPY array is not writeable...&quot;</span>
        <span class="c1"># after torch.as_tensor(B)</span>
        <span class="n">A</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">B</span> <span class="o">*</span> <span class="n">B</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">B</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="k">elif</span> <span class="n">measure</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;fourier_diag&quot;</span><span class="p">,</span> <span class="s2">&quot;foud&quot;</span><span class="p">]:</span>
        <span class="c1"># Essentially equivalent to S4D-Lin</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">freqs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">A</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">A</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">B</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">measure</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;fourier&quot;</span><span class="p">,</span> <span class="s2">&quot;fout&quot;</span><span class="p">]:</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span> <span class="n">freqs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Subtract off rank correction - this corresponds</span>
        <span class="c1"># to the other endpoint u(t-1) in this case</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">A</span> <span class="o">-</span> <span class="n">B</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">B</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span></div>


<div class="viewcode-block" id="rank_correction"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.rank_correction">[docs]</a><span class="k">def</span> <span class="nf">rank_correction</span><span class="p">(</span><span class="n">measure</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return low-rank matrix L such that A + L is normal.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">measure</span> <span class="o">==</span> <span class="s2">&quot;legs&quot;</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">rank</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">))</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (1 N)</span>
    <span class="k">elif</span> <span class="n">measure</span> <span class="o">==</span> <span class="s2">&quot;legt&quot;</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">rank</span> <span class="o">&gt;=</span> <span class="mi">2</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">))</span>  <span class="c1"># (N)</span>
        <span class="n">P0</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">P0</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">P1</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">P1</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">P0</span><span class="p">,</span> <span class="n">P1</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (2 N)</span>
        <span class="n">P</span> <span class="o">*=</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span>
            <span class="o">-</span><span class="mf">0.5</span>
        <span class="p">)</span>  <span class="c1"># Halve the rank correct just like the original matrix was halved</span>
    <span class="k">elif</span> <span class="n">measure</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;fourier&quot;</span><span class="p">,</span> <span class="s2">&quot;fout&quot;</span><span class="p">]:</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">measure</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;fourier_diag&quot;</span><span class="p">,</span> <span class="s2">&quot;foud&quot;</span><span class="p">,</span> <span class="s2">&quot;legsd&quot;</span><span class="p">]:</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rank</span> <span class="o">&gt;</span> <span class="n">d</span><span class="p">:</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">P</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">rank</span> <span class="o">-</span> <span class="n">d</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (rank N)</span>
    <span class="k">return</span> <span class="n">P</span></div>


<div class="viewcode-block" id="nplr"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.nplr">[docs]</a><span class="k">def</span> <span class="nf">nplr</span><span class="p">(</span><span class="n">measure</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">diagonalize_precision</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decompose as Normal Plus Low-Rank (NPLR).</span>

<span class="sd">    Return w, p, q, V, B such that</span>
<span class="sd">    (w - p q^*, B) is unitarily equivalent to the original HiPPO A, B by the matrix V</span>
<span class="sd">    i.e. A = V[w - p q^*]V^*, B = V B</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">float</span> <span class="ow">or</span> <span class="n">torch</span><span class="o">.</span><span class="n">double</span>
    <span class="n">cdtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cfloat</span> <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">float</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">cdouble</span>

    <span class="n">A</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="n">transition</span><span class="p">(</span><span class="n">measure</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>  <span class="c1"># (N, N)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># (N,)</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">rank_correction</span><span class="p">(</span><span class="n">measure</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">rank</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>  <span class="c1"># (r N)</span>
    <span class="n">AP</span> <span class="o">=</span> <span class="n">A</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">P</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># We require AP to be nearly skew-symmetric</span>
    <span class="n">_A</span> <span class="o">=</span> <span class="n">AP</span> <span class="o">+</span> <span class="n">AP</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># if not torch.allclose(_A - _A[0,0]*torch.eye(N), torch.zeros(N, N), atol=1e-5):</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">_A</span> <span class="o">-</span> <span class="n">_A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">N</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">&gt;</span> <span class="mf">1e-5</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: HiPPO matrix not skew symmetric&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>

    <span class="c1"># Take advantage of identity + skew-symmetric form</span>
    <span class="c1"># to calculate real and imaginary parts separately</span>
    <span class="c1"># Imaginary part can use eigh instead of eig</span>
    <span class="n">w_re</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">AP</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Diagonalize in double precision</span>
    <span class="k">if</span> <span class="n">diagonalize_precision</span><span class="p">:</span>
        <span class="n">AP</span> <span class="o">=</span> <span class="n">AP</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">w_im</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">AP</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">)</span>  <span class="c1"># (..., N) (..., N, N)</span>
    <span class="k">if</span> <span class="n">diagonalize_precision</span><span class="p">:</span>
        <span class="n">w_im</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">w_im</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">cdtype</span><span class="p">),</span> <span class="n">V</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">cdtype</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">w_re</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">w_im</span>
    <span class="c1"># Check: V w V^{-1} = A</span>
    <span class="c1"># print(&quot;check&quot;, V @ torch.diag_embed(w) @ V.conj().transpose(-1, -2))</span>

    <span class="c1"># Only keep half of each conjugate pair</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span>
    <span class="n">w_sorted</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">V_sorted</span> <span class="o">=</span> <span class="n">V</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span>

    <span class="c1"># There is an edge case when eigenvalues can be 0,</span>
    <span class="c1"># which requires some machinery to handle</span>
    <span class="c1"># We use a huge hack here: Assume only one pair is 0,</span>
    <span class="c1"># and that it is the first row/column of A (only happens in Fourier case)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">V_sorted</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">w_sorted</span><span class="p">[:</span> <span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">w</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="s2">&quot;Only 1 zero eigenvalue allowed in diagonal part of A&quot;</span>
    <span class="k">if</span> <span class="n">w</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">:</span>
        <span class="n">V</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**-</span><span class="mf">0.5</span>
        <span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span>

    <span class="n">_AP</span> <span class="o">=</span> <span class="n">V</span> <span class="o">@</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag_embed</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">@</span> <span class="n">V</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">_AP</span><span class="o">.</span><span class="n">real</span> <span class="o">-</span> <span class="n">AP</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">&gt;</span> <span class="mf">1e-5</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Warning: Diagonalization of A matrix not numerically precise - error&quot;</span><span class="p">,</span> <span class="n">err</span>
        <span class="p">)</span>
    <span class="c1"># print(&quot;check&quot;, V @ torch.diag_embed(w) @ V.conj().transpose(-1, -2))</span>

    <span class="n">V_inv</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s2">&quot;ij, j -&gt; i&quot;</span><span class="p">,</span> <span class="n">V_inv</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>  <span class="c1"># V^* B</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s2">&quot;ij, ...j -&gt; ...i&quot;</span><span class="p">,</span> <span class="n">V_inv</span><span class="p">,</span> <span class="n">P</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>  <span class="c1"># V^* P</span>

    <span class="k">return</span> <span class="n">w</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">V</span></div>


<div class="viewcode-block" id="dplr"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.dplr">[docs]</a><span class="k">def</span> <span class="nf">dplr</span><span class="p">(</span>
    <span class="n">scaling</span><span class="p">,</span>
    <span class="n">N</span><span class="p">,</span>
    <span class="n">rank</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">H</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span>
    <span class="n">real_scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">imag_scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">random_real</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">random_imag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">diagonal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">random_B</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">assert</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">float</span> <span class="ow">or</span> <span class="n">torch</span><span class="o">.</span><span class="n">double</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cfloat</span> <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">float</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">cdouble</span>

    <span class="n">pi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">random_real</span><span class="p">:</span>
        <span class="n">real_part</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">real_part</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">random_imag</span><span class="p">:</span>
        <span class="n">imag_part</span> <span class="o">=</span> <span class="n">N</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">imag_part</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;n -&gt; h n&quot;</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">H</span><span class="p">)</span>

    <span class="n">real_part</span> <span class="o">=</span> <span class="n">real_scale</span> <span class="o">*</span> <span class="n">real_part</span>
    <span class="k">if</span> <span class="n">scaling</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
        <span class="n">imag_part</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">scaling</span> <span class="o">==</span> <span class="s2">&quot;real&quot;</span><span class="p">:</span>
        <span class="n">imag_part</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">imag_part</span>
        <span class="n">real_part</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">repeat</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;n -&gt; h n&quot;</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">H</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">scaling</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="s2">&quot;lin&quot;</span><span class="p">]:</span>
        <span class="n">imag_part</span> <span class="o">=</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">imag_part</span>
    <span class="k">elif</span> <span class="n">scaling</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s2">&quot;inverse&quot;</span><span class="p">,</span>
        <span class="s2">&quot;inv&quot;</span><span class="p">,</span>
    <span class="p">]:</span>  <span class="c1"># Based on asymptotics of the default HiPPO matrix</span>
        <span class="n">imag_part</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">N</span> <span class="o">*</span> <span class="p">(</span><span class="n">N</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">imag_part</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">scaling</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;inverse2&quot;</span><span class="p">,</span> <span class="s2">&quot;inv2&quot;</span><span class="p">]:</span>
        <span class="n">imag_part</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">N</span> <span class="o">*</span> <span class="p">(</span><span class="n">N</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">imag_part</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">scaling</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;quadratic&quot;</span><span class="p">,</span> <span class="s2">&quot;quad&quot;</span><span class="p">]:</span>
        <span class="n">imag_part</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">imag_part</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">scaling</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;legs&quot;</span><span class="p">,</span> <span class="s2">&quot;hippo&quot;</span><span class="p">]:</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">nplr</span><span class="p">(</span><span class="s2">&quot;legsd&quot;</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">imag_part</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">imag</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
    <span class="n">imag_part</span> <span class="o">=</span> <span class="n">imag_scale</span> <span class="o">*</span> <span class="n">imag_part</span>
    <span class="n">w</span> <span class="o">=</span> <span class="o">-</span><span class="n">real_part</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">imag_part</span>

    <span class="c1"># Initialize B</span>
    <span class="k">if</span> <span class="n">random_B</span><span class="p">:</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="p">(</span>
            <span class="o">-</span><span class="n">B</span> <span class="o">/</span> <span class="n">w</span>
        <span class="p">)</span>  <span class="c1"># (H, N) # Result if you integrate the kernel with constant 1 function</span>
        <span class="n">zeta</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>  <span class="c1"># Variance with a random C vector</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">B</span> <span class="o">/</span> <span class="n">zeta</span><span class="o">**</span><span class="mf">0.5</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">diagonal</span><span class="p">:</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">*</span> <span class="mf">0.0</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)[::</span> <span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># Only used in testing</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="s2">&quot;n m -&gt; h n m&quot;</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">H</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">w</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">V</span></div>


<div class="viewcode-block" id="ssm"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.ssm">[docs]</a><span class="k">def</span> <span class="nf">ssm</span><span class="p">(</span><span class="n">measure</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="o">**</span><span class="n">ssm_args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dispatcher to create single SSM initialization.</span>

<span class="sd">    N: state size</span>
<span class="sd">    R: rank (for DPLR parameterization)</span>
<span class="sd">    H: number of independent SSM copies</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">measure</span> <span class="o">==</span> <span class="s2">&quot;dplr&quot;</span><span class="p">:</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">dplr</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">R</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="n">H</span><span class="p">,</span> <span class="o">**</span><span class="n">ssm_args</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">measure</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;diag&quot;</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;diag&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">dplr</span><span class="p">(</span><span class="n">scaling</span><span class="o">=</span><span class="n">scaling</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">R</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="n">H</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">ssm_args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">nplr</span><span class="p">(</span><span class="n">measure</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="o">**</span><span class="n">ssm_args</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="s2">&quot;n -&gt; s n&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">H</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="s2">&quot;r n -&gt; r s n&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">H</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="s2">&quot;n -&gt; s n&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">H</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="s2">&quot;n m -&gt; s n m&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">H</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">w</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">V</span></div>


<span class="n">combinations</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;hippo&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;legs&quot;</span><span class="p">,</span> <span class="s2">&quot;fourier&quot;</span><span class="p">],</span>
    <span class="s2">&quot;diag&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;diag-inv&quot;</span><span class="p">,</span> <span class="s2">&quot;diag-lin&quot;</span><span class="p">],</span>
    <span class="s2">&quot;all&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;legs&quot;</span><span class="p">,</span> <span class="s2">&quot;fourier&quot;</span><span class="p">,</span> <span class="s2">&quot;diag-inv&quot;</span><span class="p">,</span> <span class="s2">&quot;diag-lin&quot;</span><span class="p">],</span>
<span class="p">}</span>


<div class="viewcode-block" id="combination"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.combination">[docs]</a><span class="k">def</span> <span class="nf">combination</span><span class="p">(</span><span class="n">measures</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="o">**</span><span class="n">ssm_args</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">measures</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">measures</span> <span class="o">=</span> <span class="n">combinations</span><span class="p">[</span><span class="n">measures</span><span class="p">]</span> <span class="k">if</span> <span class="n">measures</span> <span class="ow">in</span> <span class="n">combinations</span> <span class="k">else</span> <span class="p">[</span><span class="n">measures</span><span class="p">]</span>

    <span class="k">assert</span> <span class="n">S</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">measures</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2"> independent trainable SSM copies must be multiple of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">measures</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="s2">&quot;different measures&quot;</span>
    <span class="p">)</span>
    <span class="n">w</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="o">*</span><span class="p">[</span><span class="n">ssm</span><span class="p">(</span><span class="n">measure</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">S</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">measures</span><span class="p">),</span> <span class="o">**</span><span class="n">ssm_args</span><span class="p">)</span> <span class="k">for</span> <span class="n">measure</span> <span class="ow">in</span> <span class="n">measures</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (S N)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (R S N)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (S N)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (S N N)</span>
    <span class="k">return</span> <span class="n">w</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">V</span></div>


<div class="viewcode-block" id="OptimModule"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.OptimModule">[docs]</a><span class="k">class</span> <span class="nc">OptimModule</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interface for Module that allows registering buffers/parameters with configurable optimizer hyperparameters. # noqa&quot;&quot;&quot;</span>

<div class="viewcode-block" id="OptimModule.register"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.OptimModule.register">[docs]</a>    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tensor</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register a tensor with a configurable learning rate and 0 weight decay.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">lr</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tensor</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register_parameter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">tensor</span><span class="p">))</span>

            <span class="n">optim</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;weight_decay&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">lr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">optim</span><span class="p">[</span><span class="s2">&quot;lr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lr</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="s2">&quot;_optim&quot;</span><span class="p">,</span> <span class="n">optim</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SSKernelNPLR"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.SSKernelNPLR">[docs]</a><span class="k">class</span> <span class="nc">SSKernelNPLR</span><span class="p">(</span><span class="n">OptimModule</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stores a representation of and computes the SSKernel function.</span>

<span class="sd">    K_L(A^dt, B^dt, C) corresponding to a discretized state space,</span>
<span class="sd">    where A is Normal + Low Rank (NPLR)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_setup_C</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct C~ from C.</span>

<span class="sd">        Two modes are supported: go directly to length L if self.L is 1,</span>
<span class="sd">        or length is doubled</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S4: Initializing kernel to length </span><span class="si">{</span><span class="n">L</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">double_length</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">L</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">item</span><span class="p">():</span>  <span class="c1"># 2*int(self.L) == L:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;S4: Doubling length from L = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">double_length</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>  <span class="c1"># Convenience for the math below</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">C</span> <span class="o">=</span> <span class="n">_r2c</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>
        <span class="n">dA</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_state</span><span class="p">()</span>
        <span class="n">dA_L</span> <span class="o">=</span> <span class="n">power</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">dA</span><span class="p">)</span>
        <span class="c1"># Multiply C by I - dA_L</span>
        <span class="n">C_</span> <span class="o">=</span> <span class="n">_conj</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
        <span class="n">prod</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s2">&quot;h m n, c h n -&gt; c h m&quot;</span><span class="p">,</span> <span class="n">dA_L</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">),</span> <span class="n">C_</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">double_length</span><span class="p">:</span>
            <span class="n">prod</span> <span class="o">=</span> <span class="o">-</span><span class="n">prod</span>  <span class="c1"># Multiply by I + dA_L instead</span>
        <span class="n">C_</span> <span class="o">=</span> <span class="n">C_</span> <span class="o">-</span> <span class="n">prod</span>
        <span class="n">C_</span> <span class="o">=</span> <span class="n">C_</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">]</span>  <span class="c1"># Take conjugate pairs again</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">_c2r</span><span class="p">(</span><span class="n">C_</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="k">if</span> <span class="n">double_length</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">+</span> <span class="n">L</span>  <span class="c1"># Preserve type/device</span>

    <span class="k">def</span> <span class="nf">_omega</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate (and cache) FFT nodes and their &quot;unprocessed&quot; version with the bilinear transform. # noqa</span>

<span class="sd">        This should be called everytime the internal length self.L changes</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Use cached if available</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;omega&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">L</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span>

        <span class="n">omega</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="n">L</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
        <span class="p">)</span>  <span class="c1"># \omega_{2L}</span>
        <span class="n">omega</span> <span class="o">=</span> <span class="n">omega</span> <span class="o">**</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">omega</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">omega</span><span class="p">)</span>

        <span class="c1"># Cache if necessary</span>
        <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">omega</span> <span class="o">=</span> <span class="n">omega</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">z</span>
        <span class="k">return</span> <span class="n">omega</span><span class="p">,</span> <span class="n">z</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">w</span><span class="p">,</span>
        <span class="n">P</span><span class="p">,</span>
        <span class="n">B</span><span class="p">,</span>
        <span class="n">C</span><span class="p">,</span>
        <span class="n">log_dt</span><span class="p">,</span>
        <span class="n">L</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># starting/maximum length of kernel</span>
        <span class="n">lr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">keops</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">real_type</span><span class="o">=</span><span class="s2">&quot;exp&quot;</span><span class="p">,</span>  <span class="c1"># [&#39;none&#39; | &#39;exp&#39; | &#39;relu&#39; | sigmoid&#39;]</span>
        <span class="n">real_tolerance</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
        <span class="n">bandlimit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize kernel.</span>

<span class="sd">        L: Maximum length; this module computes an SSM kernel of length L</span>
<span class="sd">        A is represented by diag(w) - PP^*</span>
<span class="sd">        w: (S, N) diagonal part</span>
<span class="sd">        P: (R, S, N) low-rank part</span>

<span class="sd">        B: (S, N)</span>
<span class="sd">        C: (C, H, N)</span>
<span class="sd">        dt: (H) timescale per feature</span>
<span class="sd">        lr: [dict | float | None] hook to set lr of special parameters (A, B, dt)</span>

<span class="sd">        Dimensions:</span>
<span class="sd">        N (or d_state): state size</span>
<span class="sd">        H (or d_model): total SSM copies</span>
<span class="sd">        S (or n_ssm): number of trainable copies of (A, B, dt); must divide H</span>
<span class="sd">        R (or rank): rank of low-rank part</span>
<span class="sd">        C (or channels): system is 1-dim to C-dim</span>

<span class="sd">        The forward pass of this Module returns a tensor of shape (C, H, L)</span>

<span class="sd">        Note: tensor shape N here denotes half the true state size,</span>
<span class="sd">            because of conjugate symmetry</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keops</span> <span class="o">=</span> <span class="n">keops</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bandlimit</span> <span class="o">=</span> <span class="n">bandlimit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">real_type</span> <span class="o">=</span> <span class="n">real_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">real_tolerance</span> <span class="o">=</span> <span class="n">real_tolerance</span>

        <span class="c1"># Rank of low-rank correction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">w</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">P</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">B</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">C</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">log_dt</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Check different SSM inits</span>
        <span class="k">assert</span> <span class="n">w</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="n">P</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="n">B</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># n_ssm</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">%</span> <span class="n">w</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_ssm</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">broadcast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">//</span> <span class="n">w</span><span class="o">.</span><span class="n">size</span><span class="p">(</span>
            <span class="mi">0</span>
        <span class="p">)</span>  <span class="c1"># Each trainable SSM needs to be duplicated this many times</span>

        <span class="c1"># Broadcast everything to correct shapes</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">broadcast_shapes</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)))</span>  <span class="c1"># (C, H, N)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># (1, 1, N)</span>

        <span class="c1"># Register parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">_c2r</span><span class="p">(</span><span class="n">_resolve_conj</span><span class="p">(</span><span class="n">C</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">lr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">lr_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lr_dict</span><span class="p">,</span> <span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span><span class="p">,</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;log_dt&quot;</span><span class="p">,</span> <span class="n">log_dt</span><span class="p">,</span> <span class="n">lr_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dt&quot;</span><span class="p">,</span> <span class="n">lr</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">_c2r</span><span class="p">(</span><span class="n">B</span><span class="p">),</span> <span class="n">lr_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">lr</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="n">_c2r</span><span class="p">(</span><span class="n">P</span><span class="p">),</span> <span class="n">lr_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="n">lr</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;inv_w_real&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_w_init</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">real</span><span class="p">),</span> <span class="n">lr_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="n">lr</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;w_imag&quot;</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">lr_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="n">lr</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span> <span class="o">=</span> <span class="n">L</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>  <span class="c1"># Internal length</span>

    <span class="k">def</span> <span class="nf">_w_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w_real</span><span class="p">):</span>
        <span class="n">w_real</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">w_real</span><span class="p">,</span> <span class="nb">max</span><span class="o">=-</span><span class="bp">self</span><span class="o">.</span><span class="n">real_tolerance</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_type</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">w_real</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_type</span> <span class="o">==</span> <span class="s2">&quot;exp&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="o">-</span><span class="n">w_real</span><span class="p">)</span>  <span class="c1"># Some of the HiPPO methods have real part 0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_type</span> <span class="o">==</span> <span class="s2">&quot;relu&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">w_real</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_type</span> <span class="o">==</span> <span class="s2">&quot;sigmoid&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">logit</span><span class="p">(</span><span class="o">-</span><span class="n">w_real</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_type</span> <span class="o">==</span> <span class="s2">&quot;softplus&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">w_real</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_w</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get the internal w (diagonal) parameter</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_type</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="n">w_real</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">inv_w_real</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_type</span> <span class="o">==</span> <span class="s2">&quot;exp&quot;</span><span class="p">:</span>
            <span class="n">w_real</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inv_w_real</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_type</span> <span class="o">==</span> <span class="s2">&quot;relu&quot;</span><span class="p">:</span>
            <span class="n">w_real</span> <span class="o">=</span> <span class="o">-</span><span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inv_w_real</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_type</span> <span class="o">==</span> <span class="s2">&quot;sigmoid&quot;</span><span class="p">:</span>
            <span class="n">w_real</span> <span class="o">=</span> <span class="o">-</span><span class="n">F</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inv_w_real</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_type</span> <span class="o">==</span> <span class="s2">&quot;softplus&quot;</span><span class="p">:</span>
            <span class="n">w_real</span> <span class="o">=</span> <span class="o">-</span><span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inv_w_real</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">w_real</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_imag</span>
        <span class="k">return</span> <span class="n">w</span>

<div class="viewcode-block" id="SSKernelNPLR.forward"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.SSKernelNPLR.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Forward pass.</span>

<span class="sd">        state: (B, H, N) initial state</span>
<span class="sd">        rate: sampling rate factor</span>
<span class="sd">        L: target length</span>

<span class="sd">        returns:</span>
<span class="sd">        (C, H, L) convolution kernel (generally C=1)</span>
<span class="sd">        (B, H, L) output from initial state</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize C~</span>
        <span class="c1"># if necessary (done in forward pass so it&#39;s on the correct device)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_C</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l_max</span><span class="p">)</span>

        <span class="c1"># Handle sampling rate logic</span>
        <span class="c1"># The idea is that this kernel&#39;s length (in continuous units) is self.L,</span>
        <span class="c1"># while we are asked</span>
        <span class="c1"># to provide a kernel of length L at (relative) frequency rate</span>
        <span class="k">if</span> <span class="n">L</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">L</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="n">rate</span><span class="p">)</span>

        <span class="c1"># Increase the internal length if needed</span>
        <span class="n">continuous_L</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">rate</span> <span class="o">*</span> <span class="n">L</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">continuous_L</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">item</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_C</span><span class="p">(</span><span class="n">continuous_L</span><span class="p">)</span>
        <span class="n">discrete_L</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="n">rate</span><span class="p">)</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">rate</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">_r2c</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">_r2c</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">_r2c</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">)</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_w</span><span class="p">()</span>  <span class="c1"># (n_ssm, N)</span>

        <span class="c1"># Address bandlimiting</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandlimit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">freqs</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">imag</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>  <span class="c1"># (H, N)</span>
            <span class="n">freqs</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">/</span> <span class="n">rate</span> <span class="o">*</span> <span class="n">freqs</span>  <span class="c1"># (H, N)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">freqs</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandlimit</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">C</span> <span class="o">*</span> <span class="n">mask</span>

        <span class="c1"># Get FFT nodes of right length</span>
        <span class="n">omega</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omega</span><span class="p">(</span>
            <span class="n">discrete_L</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Broadcast parameters to same hidden features H</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="s2">&quot;1 t n -&gt; 1 (v t) n&quot;</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">broadcast</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="s2">&quot;r t n -&gt; r (v t) n&quot;</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">broadcast</span><span class="p">)</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="s2">&quot;r t n -&gt; r (v t) n&quot;</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">broadcast</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="s2">&quot;t n -&gt; (v t) n&quot;</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">broadcast</span><span class="p">)</span>

        <span class="c1"># Augment B</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Have to &quot;unbilinear&quot; the state to put it into the same &quot;type&quot; as B</span>
            <span class="c1"># Compute 1/dt * (I + dt/2 A) @ state</span>

            <span class="c1"># Can do this without expanding</span>
            <span class="c1"># (maybe minor speedup using conj symmetry in theory),</span>
            <span class="c1"># but it&#39;s easier to read this way</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">_conj</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="k">else</span> <span class="n">state</span>  <span class="c1"># (B H N)</span>
            <span class="n">sA</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">_conj</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="n">contract</span><span class="p">(</span>  <span class="c1"># (B H N)</span>
                <span class="s2">&quot;bhm, rhm, rhn -&gt; bhn&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">_conj</span><span class="p">(</span><span class="n">Q</span><span class="p">),</span> <span class="n">_conj</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="n">dt</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">sA</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">]</span>

            <span class="n">B</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">s</span><span class="p">,</span> <span class="n">B</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># (B+1, H, N)</span>

        <span class="c1"># Incorporate dt into A</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">dt</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (H N)</span>

        <span class="c1"># Stack B and p, C and q for convenient batching</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">B</span><span class="p">,</span> <span class="n">P</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># (B+1+R, H, N)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">C</span><span class="p">,</span> <span class="n">Q</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># (C+R, H, N)</span>

        <span class="c1"># Incorporate B and C batch dimensions</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">C</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>  <span class="c1"># (B+1+R, C+R, H, N)</span>

        <span class="c1"># Calculate resolvent at omega</span>
        <span class="k">if</span> <span class="n">has_cauchy_extension</span> <span class="ow">and</span> <span class="n">z</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">cfloat</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">keops</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">cauchy_mult</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">has_pykeops</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">cauchy_conj</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">cauchy_naive</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">dt</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span>  <span class="c1"># (B+1+R, C+R, H, L)</span>

        <span class="c1"># Low-rank Woodbury correction</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">k_f</span> <span class="o">=</span> <span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">/</span> <span class="p">(</span>
                <span class="mi">1</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">r00</span> <span class="o">=</span> <span class="n">r</span><span class="p">[:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="p">:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">r01</span> <span class="o">=</span> <span class="n">r</span><span class="p">[:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">r10</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="p">:,</span> <span class="p">:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">r11</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="p">:,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">det</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">r11</span><span class="p">[:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">r11</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">-</span> <span class="n">r11</span><span class="p">[</span>
                <span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:</span>
            <span class="p">]</span> <span class="o">*</span> <span class="n">r11</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">r01</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">r11</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">*</span> <span class="n">r10</span><span class="p">[:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="o">+</span> <span class="n">r01</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">r11</span><span class="p">[:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">*</span> <span class="n">r10</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="o">-</span> <span class="n">r01</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">r11</span><span class="p">[:</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">*</span> <span class="n">r10</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="o">-</span> <span class="n">r01</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">r11</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">*</span> <span class="n">r10</span><span class="p">[:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="n">det</span>
            <span class="n">k_f</span> <span class="o">=</span> <span class="n">r00</span> <span class="o">-</span> <span class="n">s</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r00</span> <span class="o">=</span> <span class="n">r</span><span class="p">[:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="p">:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">r01</span> <span class="o">=</span> <span class="n">r</span><span class="p">[:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">r10</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="p">:,</span> <span class="p">:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">r11</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="p">:,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">r11</span> <span class="o">=</span> <span class="n">rearrange</span><span class="p">(</span><span class="n">r11</span><span class="p">,</span> <span class="s2">&quot;a b h n -&gt; h n a b&quot;</span><span class="p">)</span>
            <span class="n">r11</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">+</span> <span class="n">r11</span><span class="p">)</span>
            <span class="n">r11</span> <span class="o">=</span> <span class="n">rearrange</span><span class="p">(</span><span class="n">r11</span><span class="p">,</span> <span class="s2">&quot;h n a b -&gt; a b h n&quot;</span><span class="p">)</span>
            <span class="n">k_f</span> <span class="o">=</span> <span class="n">r00</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span>
                <span class="s2">&quot;i j h n, j k h n, k l h n -&gt; i l h n&quot;</span><span class="p">,</span> <span class="n">r01</span><span class="p">,</span> <span class="n">r11</span><span class="p">,</span> <span class="n">r10</span>
            <span class="p">)</span>

        <span class="c1"># Final correction for the bilinear transform</span>
        <span class="n">k_f</span> <span class="o">=</span> <span class="n">k_f</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">omega</span><span class="p">)</span>

        <span class="c1"># Move from frequency to coefficients</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">k_f</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">discrete_L</span><span class="p">)</span>  <span class="c1"># (B+1, C, H, L)</span>

        <span class="c1"># # Truncate to target length</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">L</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">k_state</span> <span class="o">=</span> <span class="n">k</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># (B, C, H, L)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">k_state</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">k_B</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># (C H L)</span>

        <span class="k">return</span> <span class="n">k_B</span><span class="p">,</span> <span class="n">k_state</span></div>

    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_setup_linear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create parameters that allow fast linear stepping of state.&quot;&quot;&quot;</span>
        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_w</span><span class="p">()</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">_r2c</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">)</span>  <span class="c1"># (H N)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">_r2c</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">)</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

        <span class="c1"># Repeat w shape properly</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="s2">&quot;1 t n -&gt; 1 (v t) n&quot;</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">broadcast</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="s2">&quot;r t n -&gt; r (v t) n&quot;</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">broadcast</span><span class="p">)</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="s2">&quot;r t n -&gt; r (v t) n&quot;</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">broadcast</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="s2">&quot;t n -&gt; (v t) n&quot;</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">broadcast</span><span class="p">)</span>

        <span class="c1"># Prepare Linear stepping</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dt</span><span class="p">)</span>
        <span class="n">D</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">/</span> <span class="n">dt</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">()</span>  <span class="c1"># (H, N)</span>
        <span class="n">R</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">contract</span><span class="p">(</span><span class="s2">&quot;r h n, h n, s h n -&gt; h r s&quot;</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="p">)</span>  <span class="c1"># (H R R)</span>
        <span class="n">Q_D</span> <span class="o">=</span> <span class="n">rearrange</span><span class="p">(</span><span class="n">Q</span> <span class="o">*</span> <span class="n">D</span><span class="p">,</span> <span class="s2">&quot;r h n -&gt; h r n&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">Q_D</span><span class="p">)</span>  <span class="c1"># (H R N)</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span>
                    <span class="n">R</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">Q_D</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span>
                    <span class="n">Q_D</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span>
                <span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">Q_D</span><span class="p">)</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">rearrange</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="s2">&quot;h r n -&gt; r h n&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">step_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="n">D</span><span class="p">,</span>  <span class="c1"># (H N)</span>
            <span class="s2">&quot;R&quot;</span><span class="p">:</span> <span class="n">R</span><span class="p">,</span>  <span class="c1"># (R H N)</span>
            <span class="s2">&quot;P&quot;</span><span class="p">:</span> <span class="n">P</span><span class="p">,</span>  <span class="c1"># (R H N)</span>
            <span class="s2">&quot;Q&quot;</span><span class="p">:</span> <span class="n">Q</span><span class="p">,</span>  <span class="c1"># (R H N)</span>
            <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="n">B</span><span class="p">,</span>  <span class="c1"># (1 H N)</span>
            <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">dt</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span>  <span class="c1"># (H N)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_step_state_linear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Step one time step as a recurrent model.</span>

<span class="sd">        Version of the step function that has time O(N) instead of O(N^2) per step,</span>
<span class="sd">        which takes advantage of the DPLR form and bilinear discretization.</span>

<span class="sd">        Unfortunately, as currently implemented it&#39;s about 2x slower</span>
<span class="sd">        because it calls several sequential operations.</span>
<span class="sd">        Perhaps a fused CUDA kernel implementation would be much faster</span>

<span class="sd">        u: (H) input</span>
<span class="sd">        state: (H, N/2) state with conjugate pairs</span>
<span class="sd">          Optionally, the state can have last dimension N</span>
<span class="sd">        Returns: same shape as state</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">_r2c</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>  <span class="c1"># View used for dtype/device</span>

        <span class="k">if</span> <span class="n">u</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Special case used to find dA</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Special case used to find dB</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="n">step_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">state</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
        <span class="p">):</span>  <span class="c1"># Only store half of the conjugate pairs; should be true by default</span>
            <span class="c1"># There should be a slightly faster way using conjugate symmetry</span>
            <span class="k">def</span> <span class="nf">contract_fn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">contract</span><span class="p">(</span>
                    <span class="s2">&quot;r h n, r h m, ... h m -&gt; ... h n&quot;</span><span class="p">,</span> <span class="n">_conj</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">_conj</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">_conj</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                <span class="p">)[</span>
                    <span class="o">...</span><span class="p">,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
                <span class="p">]</span>  <span class="c1"># inner outer product</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">state</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
            <span class="n">step_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">_conj</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">step_params</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="c1"># Worth setting up a contract_expression in default_state</span>
            <span class="c1"># if we want to use this at inference time for stepping</span>

            <span class="k">def</span> <span class="nf">contract_fn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">contract</span><span class="p">(</span>
                    <span class="s2">&quot;r h n, r h m, ... h m -&gt; ... h n&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
                <span class="p">)</span>  <span class="c1"># inner outer product</span>

        <span class="n">D</span> <span class="o">=</span> <span class="n">step_params</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span>  <span class="c1"># (H N)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">step_params</span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">]</span>  <span class="c1"># (H N)</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">step_params</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">]</span>  <span class="c1"># (R H N)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">step_params</span><span class="p">[</span><span class="s2">&quot;P&quot;</span><span class="p">]</span>  <span class="c1"># (R H N)</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">step_params</span><span class="p">[</span><span class="s2">&quot;Q&quot;</span><span class="p">]</span>  <span class="c1"># (R H N)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">step_params</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span>  <span class="c1"># (1 H N)</span>

        <span class="n">new_state</span> <span class="o">=</span> <span class="n">E</span> <span class="o">*</span> <span class="n">state</span> <span class="o">-</span> <span class="n">contract_fn</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>  <span class="c1"># (B H N)</span>
        <span class="n">new_state</span> <span class="o">=</span> <span class="n">new_state</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">B</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (B H N)</span>
        <span class="n">new_state</span> <span class="o">=</span> <span class="n">D</span> <span class="o">*</span> <span class="p">(</span><span class="n">new_state</span> <span class="o">-</span> <span class="n">contract_fn</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">new_state</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">new_state</span>

    <span class="k">def</span> <span class="nf">_setup_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct dA and dB for discretized state equation.&quot;&quot;&quot;</span>
        <span class="c1"># Construct dA and dB by using the stepping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_linear</span><span class="p">()</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">_r2c</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>  <span class="c1"># Just returns a view that we use for finding dtype/device</span>

        <span class="n">state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span>
            <span class="o">-</span><span class="mi">2</span>
        <span class="p">)</span>  <span class="c1"># (N 1 N)</span>
        <span class="n">dA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step_state_linear</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>
        <span class="n">dA</span> <span class="o">=</span> <span class="n">rearrange</span><span class="p">(</span><span class="n">dA</span><span class="p">,</span> <span class="s2">&quot;n h m -&gt; h m n&quot;</span><span class="p">)</span>

        <span class="n">u</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">new_ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">)</span>
        <span class="n">dB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step_state_linear</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">)</span>
        <span class="n">dB</span> <span class="o">=</span> <span class="n">_conj</span><span class="p">(</span><span class="n">dB</span><span class="p">)</span>
        <span class="n">dB</span> <span class="o">=</span> <span class="n">rearrange</span><span class="p">(</span><span class="n">dB</span><span class="p">,</span> <span class="s2">&quot;1 h n -&gt; h n&quot;</span><span class="p">)</span>  <span class="c1"># (H N)</span>
        <span class="k">return</span> <span class="n">dA</span><span class="p">,</span> <span class="n">dB</span>

    <span class="k">def</span> <span class="nf">_step_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Step one time step as a recurrent model.</span>

<span class="sd">        Must be called after self.default_state() is used to construct an initial state!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">next_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_contraction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dA</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_contraction</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dB</span><span class="p">,</span> <span class="n">u</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">next_state</span>

    <span class="k">def</span> <span class="nf">_setup_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;dense&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up dA, dB, dC discretized parameters for stepping.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_state</span><span class="p">()</span>

        <span class="c1"># Calculate original C</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">_conj</span><span class="p">(</span><span class="n">_r2c</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">))</span>  <span class="c1"># (H C N)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dC</span> <span class="o">=</span> <span class="n">C</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># self.C represents C_tilde</span>
            <span class="n">dA_L</span> <span class="o">=</span> <span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dA</span><span class="p">)</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dA</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dA_L</span><span class="p">)</span>

            <span class="n">dC</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span>
                <span class="n">E</span> <span class="o">-</span> <span class="n">dA_L</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">),</span>
                <span class="n">C</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dC</span> <span class="o">=</span> <span class="n">dC</span>

        <span class="c1"># Do special preprocessing for different step modes</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_step_mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
            <span class="c1"># Linear case: special step function for the state, we need to handle output</span>
            <span class="c1"># use conjugate symmetry by default, which affects the output projection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dC</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dC</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;diagonal&quot;</span><span class="p">:</span>
            <span class="c1"># Eigendecomposition of the A matrix</span>
            <span class="n">L</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dA</span><span class="p">)</span>
            <span class="n">V_inv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
            <span class="c1"># Check that the eigendedecomposition is correct</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Diagonalization error:&quot;</span><span class="p">,</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">V</span> <span class="o">@</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag_embed</span><span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="o">@</span> <span class="n">V_inv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dA</span><span class="p">),</span>
                <span class="p">)</span>

            <span class="c1"># Change the parameterization to diagonalize</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dA</span> <span class="o">=</span> <span class="n">L</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dB</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s2">&quot;h n m, h m -&gt; h n&quot;</span><span class="p">,</span> <span class="n">V_inv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dB</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dC</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s2">&quot;h n m, c h n -&gt; c h m&quot;</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dC</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;dense&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;NPLR Kernel step mode must be {&#39;dense&#39; | &#39;linear&#39; | &#39;diagonal&#39;}&quot;</span>
            <span class="p">)</span>

<div class="viewcode-block" id="SSKernelNPLR.default_state"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.SSKernelNPLR.default_state">[docs]</a>    <span class="k">def</span> <span class="nf">default_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">batch_shape</span><span class="p">):</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">_r2c</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Cache the tensor contractions we will later do, for efficiency</span>
        <span class="c1"># These are put in this function because they depend on the batch size</span>
        <span class="n">step_mode</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_step_mode&quot;</span><span class="p">,</span> <span class="s2">&quot;dense&quot;</span><span class="p">)</span>  <span class="c1"># Used in default_state,</span>
        <span class="c1"># which is called without _setup_step() in forward_state()</span>
        <span class="k">if</span> <span class="n">step_mode</span> <span class="o">!=</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
            <span class="n">N</span> <span class="o">*=</span> <span class="mi">2</span>

            <span class="k">if</span> <span class="n">step_mode</span> <span class="o">==</span> <span class="s2">&quot;diagonal&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_contraction</span> <span class="o">=</span> <span class="n">contract_expression</span><span class="p">(</span>
                    <span class="s2">&quot;h n, ... h n -&gt; ... h n&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span>
                    <span class="n">batch_shape</span> <span class="o">+</span> <span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Dense (quadratic) case: expand all terms</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_contraction</span> <span class="o">=</span> <span class="n">contract_expression</span><span class="p">(</span>
                    <span class="s2">&quot;h m n, ... h n -&gt; ... h m&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span>
                    <span class="n">batch_shape</span> <span class="o">+</span> <span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">input_contraction</span> <span class="o">=</span> <span class="n">contract_expression</span><span class="p">(</span>
                <span class="s2">&quot;h n, ... h -&gt; ... h n&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span>
                <span class="n">batch_shape</span> <span class="o">+</span> <span class="p">(</span><span class="n">H</span><span class="p">,),</span>  <span class="c1"># self.dB.shape</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output_contraction</span> <span class="o">=</span> <span class="n">contract_expression</span><span class="p">(</span>
            <span class="s2">&quot;c h n, ... h n -&gt; ... c h&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">H</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span>  <span class="c1"># self.dC.shape</span>
            <span class="n">batch_shape</span> <span class="o">+</span> <span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="o">*</span><span class="n">batch_shape</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span></div>

<div class="viewcode-block" id="SSKernelNPLR.step"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.SSKernelNPLR.step">[docs]</a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Step one time step as a recurrent model.</span>

<span class="sd">        Must have called self._setup_step()</span>
<span class="sd">        and created state with self.default_state() before calling this</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step_mode</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
            <span class="n">new_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step_state_linear</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step_state</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_contraction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dC</span><span class="p">,</span> <span class="n">new_state</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">new_state</span></div></div>


<div class="viewcode-block" id="SSKernelDiag"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.SSKernelDiag">[docs]</a><span class="k">class</span> <span class="nc">SSKernelDiag</span><span class="p">(</span><span class="n">OptimModule</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Version using (complex) diagonal state matrix (S4D).&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">A</span><span class="p">,</span>
        <span class="n">B</span><span class="p">,</span>
        <span class="n">C</span><span class="p">,</span>
        <span class="n">log_dt</span><span class="p">,</span>
        <span class="n">L</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">disc</span><span class="o">=</span><span class="s2">&quot;bilinear&quot;</span><span class="p">,</span>
        <span class="n">real_type</span><span class="o">=</span><span class="s2">&quot;exp&quot;</span><span class="p">,</span>
        <span class="n">lr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">bandlimit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">L</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disc</span> <span class="o">=</span> <span class="n">disc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bandlimit</span> <span class="o">=</span> <span class="n">bandlimit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">real_type</span> <span class="o">=</span> <span class="n">real_type</span>

        <span class="c1"># Rank of low-rank correction</span>
        <span class="k">assert</span> <span class="n">A</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">C</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">log_dt</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">A</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="n">B</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Number of independent SSMs trained</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">%</span> <span class="n">A</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_ssm</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">//</span> <span class="n">A</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">_c2r</span><span class="p">(</span><span class="n">_resolve_conj</span><span class="p">(</span><span class="n">C</span><span class="p">)))</span>

        <span class="c1"># Register parameters</span>
        <span class="k">if</span> <span class="n">lr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">lr_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lr_dict</span><span class="p">,</span> <span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span><span class="p">,</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;log_dt&quot;</span><span class="p">,</span> <span class="n">log_dt</span><span class="p">,</span> <span class="n">lr_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dt&quot;</span><span class="p">,</span> <span class="n">lr</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="n">_c2r</span><span class="p">(</span><span class="n">A</span><span class="p">),</span> <span class="n">lr_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="n">lr</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">_c2r</span><span class="p">(</span><span class="n">B</span><span class="p">),</span> <span class="n">lr_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">lr</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;inv_A_real&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_A_init</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">real</span><span class="p">),</span> <span class="n">lr_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="n">lr</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;A_imag&quot;</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">lr_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="n">lr</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_A_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A_real</span><span class="p">):</span>
        <span class="n">A_real</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">A_real</span><span class="p">,</span> <span class="nb">max</span><span class="o">=-</span><span class="mf">1e-4</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_type</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">A_real</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_type</span> <span class="o">==</span> <span class="s2">&quot;exp&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="o">-</span><span class="n">A_real</span><span class="p">)</span>  <span class="c1"># Some of the HiPPO methods have real part 0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_type</span> <span class="o">==</span> <span class="s2">&quot;relu&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">A_real</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_type</span> <span class="o">==</span> <span class="s2">&quot;sigmoid&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">logit</span><span class="p">(</span><span class="o">-</span><span class="n">A_real</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_type</span> <span class="o">==</span> <span class="s2">&quot;softplus&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">A_real</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_A</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get the internal A (diagonal) parameter</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_type</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="n">A_real</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">inv_A_real</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_type</span> <span class="o">==</span> <span class="s2">&quot;exp&quot;</span><span class="p">:</span>
            <span class="n">A_real</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inv_A_real</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_type</span> <span class="o">==</span> <span class="s2">&quot;relu&quot;</span><span class="p">:</span>
            <span class="c1"># JAX version seems to NaN if you alloA 0&#39;s,</span>
            <span class="c1"># although this code Aas fine Aithout it</span>
            <span class="n">A_real</span> <span class="o">=</span> <span class="o">-</span><span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inv_A_real</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1e-4</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_type</span> <span class="o">==</span> <span class="s2">&quot;sigmoid&quot;</span><span class="p">:</span>
            <span class="n">A_real</span> <span class="o">=</span> <span class="o">-</span><span class="n">F</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inv_A_real</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_type</span> <span class="o">==</span> <span class="s2">&quot;softplus&quot;</span><span class="p">:</span>
            <span class="n">A_real</span> <span class="o">=</span> <span class="o">-</span><span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inv_A_real</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">A_real</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">A_imag</span>
        <span class="k">return</span> <span class="n">A</span>

<div class="viewcode-block" id="SSKernelDiag.forward"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.SSKernelDiag.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Forward pass.</span>

<span class="sd">        state: (B, H, N) initial state</span>
<span class="sd">        rate: sampling rate factor</span>
<span class="sd">        L: target length</span>

<span class="sd">        returns:</span>
<span class="sd">        (C, H, L) convolution kernel (generally C=1)</span>
<span class="sd">        (B, H, L) output from initial state</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">rate</span>  <span class="c1"># (H)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">_r2c</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>  <span class="c1"># (C H N)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_A</span><span class="p">()</span>  <span class="c1"># (H N)</span>

        <span class="n">B</span> <span class="o">=</span> <span class="n">_r2c</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="s2">&quot;t n -&gt; 1 (v t) n&quot;</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandlimit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">freqs</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">/</span> <span class="n">rate</span> <span class="o">*</span> <span class="n">A</span><span class="o">.</span><span class="n">imag</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>  <span class="c1"># (H, N)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">freqs</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandlimit</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">C</span> <span class="o">*</span> <span class="n">mask</span>

        <span class="c1"># Incorporate dt into A</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="s2">&quot;t n -&gt; (v t) n&quot;</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repeat</span><span class="p">)</span>
        <span class="n">dtA</span> <span class="o">=</span> <span class="n">A</span> <span class="o">*</span> <span class="n">dt</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (H N)</span>

        <span class="c1"># Augment B with state</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">state</span> <span class="o">/</span> <span class="n">dt</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc</span> <span class="o">==</span> <span class="s2">&quot;bilinear&quot;</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">dtA</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc</span> <span class="o">==</span> <span class="s2">&quot;zoh&quot;</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">dtA</span> <span class="o">*</span> <span class="n">dtA</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">dtA</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">s</span><span class="p">,</span> <span class="n">B</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># (1+B H N)</span>

        <span class="n">C</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">C</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc</span> <span class="o">==</span> <span class="s2">&quot;zoh&quot;</span><span class="p">:</span>
            <span class="c1"># Power up</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">C</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">dtA</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">A</span>
            <span class="n">K</span> <span class="o">=</span> <span class="n">log_vandermonde</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">dtA</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>  <span class="c1"># (H L)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc</span> <span class="o">==</span> <span class="s2">&quot;bilinear&quot;</span><span class="p">:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">C</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">dtA</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">()</span> <span class="o">*</span> <span class="n">dt</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># or * dtA / A</span>
            <span class="n">dA</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">dtA</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">dtA</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">K</span> <span class="o">=</span> <span class="n">log_vandermonde</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">dA</span><span class="o">.</span><span class="n">log</span><span class="p">(),</span> <span class="n">L</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc</span> <span class="o">==</span> <span class="s2">&quot;dss&quot;</span><span class="p">:</span>
            <span class="c1"># Implementation from DSS meant for case</span>
            <span class="c1"># when real eigenvalues can be positive</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">dtA</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># [H N L]</span>
            <span class="n">A_gt_0</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">real</span> <span class="o">&gt;</span> <span class="mi">0</span>  <span class="c1"># [N]</span>
            <span class="k">if</span> <span class="n">A_gt_0</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                    <span class="n">P_max</span> <span class="o">=</span> <span class="n">dtA</span> <span class="o">*</span> <span class="p">(</span><span class="n">A_gt_0</span> <span class="o">*</span> <span class="p">(</span><span class="n">L</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># [H N]</span>
                <span class="n">P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">-</span> <span class="n">P_max</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [H N L]</span>
            <span class="n">S</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>  <span class="c1"># [H N L]</span>

            <span class="n">dtA_neg</span> <span class="o">=</span> <span class="n">dtA</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">A_gt_0</span><span class="p">)</span>  <span class="c1"># [H N]</span>
            <span class="n">num</span> <span class="o">=</span> <span class="n">dtA_neg</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># [H N]</span>
            <span class="n">den</span> <span class="o">=</span> <span class="p">(</span><span class="n">dtA_neg</span> <span class="o">*</span> <span class="n">L</span><span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># [H N]</span>

            <span class="c1"># Inline reciprocal function for DSS logic</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">den</span> <span class="o">*</span> <span class="n">A</span>
            <span class="n">x_conj</span> <span class="o">=</span> <span class="n">_resolve_conj</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">x_conj</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x_conj</span> <span class="o">+</span> <span class="mf">1e-7</span><span class="p">)</span>

            <span class="n">C</span> <span class="o">=</span> <span class="n">C</span> <span class="o">*</span> <span class="n">num</span> <span class="o">*</span> <span class="n">r</span>  <span class="c1"># [C H N]</span>
            <span class="n">K</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s2">&quot;chn,hnl-&gt;chl&quot;</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">disc</span><span class="si">}</span><span class="s2"> not supported&quot;</span>

        <span class="n">K</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>  <span class="c1"># (1+B C H L)</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">K_state</span> <span class="o">=</span> <span class="n">K</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># (B C H L)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">K_state</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># (C H L)</span>
        <span class="k">return</span> <span class="n">K</span><span class="p">,</span> <span class="n">K_state</span></div>

    <span class="k">def</span> <span class="nf">_setup_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># These methods are organized</span>
        <span class="c1"># like this to be compatible with the NPLR kernel interface</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dt</span><span class="p">)</span>  <span class="c1"># (H)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">_r2c</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">)</span>  <span class="c1"># (H N)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">_r2c</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>  <span class="c1"># (C H N)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dC</span> <span class="o">=</span> <span class="n">C</span>
        <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_A</span><span class="p">()</span>  <span class="c1"># (H N)</span>

        <span class="c1"># Incorporate dt into A</span>
        <span class="n">dtA</span> <span class="o">=</span> <span class="n">A</span> <span class="o">*</span> <span class="n">dt</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (H N)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc</span> <span class="o">==</span> <span class="s2">&quot;zoh&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dA</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">dtA</span><span class="p">)</span>  <span class="c1"># (H N)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dB</span> <span class="o">=</span> <span class="n">B</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">dtA</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">A</span>  <span class="c1"># (C H N)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc</span> <span class="o">==</span> <span class="s2">&quot;bilinear&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dA</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">dtA</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">dtA</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dB</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">B</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">dtA</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">()</span> <span class="o">*</span> <span class="n">dt</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># or * dtA / A</span>

<div class="viewcode-block" id="SSKernelDiag.default_state"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.SSKernelDiag.default_state">[docs]</a>    <span class="k">def</span> <span class="nf">default_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">batch_shape</span><span class="p">):</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">_r2c</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="o">*</span><span class="n">batch_shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">device</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span></div>

<div class="viewcode-block" id="SSKernelDiag.step"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.SSKernelDiag.step">[docs]</a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">next_state</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s2">&quot;h n, b h n -&gt; b h n&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dA</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="o">+</span> <span class="n">contract</span><span class="p">(</span>
            <span class="s2">&quot;h n, b h -&gt; b h n&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dB</span><span class="p">,</span> <span class="n">u</span>
        <span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s2">&quot;c h n, b h n -&gt; b c h&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dC</span><span class="p">,</span> <span class="n">next_state</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">y</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">next_state</span></div>

<div class="viewcode-block" id="SSKernelDiag.forward_state"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.SSKernelDiag.forward_state">[docs]</a>    <span class="k">def</span> <span class="nf">forward_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_step</span><span class="p">()</span>
        <span class="n">AL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dA</span> <span class="o">**</span> <span class="n">u</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dA</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>  <span class="c1"># (B H L)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">log_vandermonde_transpose</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dB</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dA</span><span class="o">.</span><span class="n">log</span><span class="p">(),</span> <span class="n">u</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">next_state</span> <span class="o">=</span> <span class="n">AL</span> <span class="o">*</span> <span class="n">state</span> <span class="o">+</span> <span class="n">v</span>
        <span class="k">return</span> <span class="n">next_state</span></div></div>


<div class="viewcode-block" id="SSKernel"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.SSKernel">[docs]</a><span class="k">class</span> <span class="nc">SSKernel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrapper around SSKernel parameterizations.</span>

<span class="sd">    The SSKernel is expected to support the interface</span>
<span class="sd">    forward()</span>
<span class="sd">    default_state()</span>
<span class="sd">    _setup_step()</span>
<span class="sd">    step()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">H</span><span class="p">,</span>
        <span class="n">N</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
        <span class="n">L</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">measure</span><span class="o">=</span><span class="s2">&quot;legs&quot;</span><span class="p">,</span>
        <span class="n">rank</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">dt_min</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
        <span class="n">dt_max</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">deterministic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">lr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;nplr&quot;</span><span class="p">,</span>
        <span class="n">n_ssm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">measure_args</span><span class="o">=</span><span class="p">{},</span>
        <span class="o">**</span><span class="n">kernel_args</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;State Space Kernel which computes the convolution kernel $\\bar{K}$.</span>

<span class="sd">        H: Number of independent SSM copies;</span>
<span class="sd">            controls the size of the model. Also called d_model in the config.</span>
<span class="sd">        N: State size (dimensionality of parameters A, B, C).</span>
<span class="sd">            Also called d_state in the config.</span>
<span class="sd">            Generally shouldn&#39;t need to be adjusted and doens&#39;t affect speed much.</span>
<span class="sd">        L: Maximum length of convolution kernel, if known.</span>
<span class="sd">            Should work in the majority of cases even if not known.</span>
<span class="sd">        measure: Options for initialization of (A, B).</span>
<span class="sd">            For NPLR mode, recommendations are &quot;legs&quot;,</span>
<span class="sd">            &quot;fout&quot;, &quot;hippo&quot; (combination of both).</span>
<span class="sd">            For Diag mode, recommendations are &quot;diag-inv&quot;,</span>
<span class="sd">            &quot;diag-lin&quot;, &quot;diag-legs&quot;, and &quot;diag&quot; (combination of diag-inv and diag-lin)</span>
<span class="sd">        rank: Rank of low-rank correction for NPLR mode.</span>
<span class="sd">            Needs to be increased for measure &quot;legt&quot;</span>
<span class="sd">        channels: C channels turns the SSM from a 1-dim to C-dim map;</span>
<span class="sd">            can think of it having C separate &quot;heads&quot; per SSM.</span>
<span class="sd">            This was partly a feature to make it easier to implement bidirectionality;</span>
<span class="sd">            it is recommended to set channels=1</span>
<span class="sd">            and adjust H to control parameters instead</span>
<span class="sd">        dt_min, dt_max: min and max values for the step size dt (\Delta)</span>
<span class="sd">        mode: Which kernel algorithm to use. &#39;nplr&#39; is the full S4 model;</span>
<span class="sd">            &#39;diag&#39; is the simpler S4D; &#39;slow&#39; is a dense version for testing</span>
<span class="sd">        n_ssm: Number of independent trainable (A, B) SSMs,</span>
<span class="sd">            e.g. n_ssm=1 means all A/B parameters are tied across</span>
<span class="sd">            the H different instantiations of C.</span>
<span class="sd">            n_ssm=None means all H SSMs are completely independent.</span>
<span class="sd">            Generally, changing this option can save parameters but doesn&#39;t affect</span>
<span class="sd">            performance or speed much. This parameter must divide H</span>
<span class="sd">        lr: Passing in a number (e.g. 0.001) sets</span>
<span class="sd">            attributes of SSM parameers (A, B, dt).</span>
<span class="sd">            A custom optimizer hook is needed to configure the optimizer</span>
<span class="sd">            to set the learning rates appropriately for these parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">N</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">H</span>
        <span class="n">dtype</span><span class="p">,</span> <span class="n">cdtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">cfloat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_ssm</span> <span class="o">=</span> <span class="n">n_ssm</span> <span class="k">if</span> <span class="n">n_ssm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">H</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_args</span> <span class="o">=</span> <span class="n">kernel_args</span>

        <span class="c1"># Generate dt</span>
        <span class="k">if</span> <span class="n">deterministic</span><span class="p">:</span>
            <span class="n">log_dt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dt_min</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dt_max</span><span class="p">),</span> <span class="n">H</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_dt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dt_max</span><span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dt_min</span><span class="p">)</span>
            <span class="p">)</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dt_min</span><span class="p">)</span>

        <span class="c1"># Compute the preprocessed representation</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">combination</span><span class="p">(</span><span class="n">measure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_ssm</span><span class="p">,</span> <span class="o">**</span><span class="n">measure_args</span><span class="p">)</span>

        <span class="c1"># Broadcast C to have H channels</span>
        <span class="k">if</span> <span class="n">deterministic</span><span class="p">:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cdtype</span><span class="p">)</span>
            <span class="n">C</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s2">&quot;hmn, chn -&gt; chm&quot;</span><span class="p">,</span> <span class="n">V</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">),</span> <span class="n">C</span><span class="p">)</span>  <span class="c1"># V^* C</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cdtype</span><span class="p">)</span>

        <span class="c1"># Broadcast other parameters to have n_ssm copies</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_ssm</span> <span class="o">%</span> <span class="n">B</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_ssm</span> <span class="o">%</span> <span class="n">P</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_ssm</span> <span class="o">%</span> <span class="n">w</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="c1"># Broadcast tensors to n_ssm copies</span>
        <span class="c1"># These will be the parameters,</span>
        <span class="c1"># so make sure tensors are materialized and contiguous</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="s2">&quot;t n -&gt; (v t) n&quot;</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_ssm</span> <span class="o">//</span> <span class="n">B</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">repeat</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="s2">&quot;r t n -&gt; r (v t) n&quot;</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_ssm</span> <span class="o">//</span> <span class="n">P</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
            <span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="s2">&quot;t n -&gt; (v t) n&quot;</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_ssm</span> <span class="o">//</span> <span class="n">w</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;nplr&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span> <span class="o">=</span> <span class="n">SSKernelNPLR</span><span class="p">(</span>
                <span class="n">w</span><span class="p">,</span>
                <span class="n">P</span><span class="p">,</span>
                <span class="n">B</span><span class="p">,</span>
                <span class="n">C</span><span class="p">,</span>
                <span class="n">log_dt</span><span class="p">,</span>
                <span class="n">L</span><span class="o">=</span><span class="n">L</span><span class="p">,</span>
                <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kernel_args</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;diag&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">measure</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;diag&quot;</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Diagonal kernel (S4D) activated but initialization is not &quot;</span>
                    <span class="s2">&quot;intended for S4D. Set `measure` to &#39;diag-lin&#39;, &#39;diag-inv&#39;, or &quot;</span>
                    <span class="s2">&quot;&#39;diag-legs&#39; for the main variants, or &#39;diag&#39; &quot;</span>
                    <span class="s2">&quot;for a combination of S4D-Lin and S4D-Inv.&quot;</span>
                <span class="p">)</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">C</span> <span class="o">*</span> <span class="n">repeat</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="s2">&quot;t n -&gt; (v t) n&quot;</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">H</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_ssm</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span> <span class="o">=</span> <span class="n">SSKernelDiag</span><span class="p">(</span>
                <span class="n">w</span><span class="p">,</span>
                <span class="n">B</span><span class="p">,</span>
                <span class="n">C</span><span class="p">,</span>
                <span class="n">log_dt</span><span class="p">,</span>
                <span class="n">L</span><span class="o">=</span><span class="n">L</span><span class="p">,</span>
                <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kernel_args</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mode=</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2"> is not valid&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="SSKernel.forward"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.SSKernel.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="n">L</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="n">rate</span><span class="p">)</span></div>

<div class="viewcode-block" id="SSKernel.forward_state"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.SSKernel.forward_state">[docs]</a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">forward_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Forward the state through a sequence.</span>

<span class="sd">        i.e. computes the state after passing chunk through SSM</span>

<span class="sd">        state: (B, H, N)</span>
<span class="sd">        u: (B, H, L)</span>

<span class="sd">        Returns: (B, H, N)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span> <span class="s2">&quot;forward_state&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">forward_state</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

        <span class="n">dA</span><span class="p">,</span> <span class="n">dB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">_setup_state</span><span class="p">()</span>  <span class="c1"># Construct dA, dB matrices</span>
        <span class="c1"># dA, dB = self.kernel.dA, self.kernel.dB # (H N N) (H N)</span>

        <span class="n">conj</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dA</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">conj</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">_conj</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span>
            <span class="s2">&quot;h n, b h l -&gt; b h n l&quot;</span><span class="p">,</span> <span class="n">dB</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># dB.unsqueeze(-1) * u.flip(-1).unsqueeze(-2)</span>
        <span class="n">AL</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">power</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">dA</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">next_state</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s2">&quot;h m n, b h n -&gt; b h m&quot;</span><span class="p">,</span> <span class="n">AL</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="n">next_state</span> <span class="o">=</span> <span class="n">next_state</span> <span class="o">+</span> <span class="n">v</span>

        <span class="k">if</span> <span class="n">conj</span><span class="p">:</span>
            <span class="n">next_state</span> <span class="o">=</span> <span class="n">next_state</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span> <span class="n">next_state</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">next_state</span></div>

    <span class="k">def</span> <span class="nf">_setup_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># This method is intended to be private so that setting up an S4 module with</span>
        <span class="c1"># ```</span>
        <span class="c1"># if hasattr(module, &#39;setup_step&#39;): module.setup_step()</span>
        <span class="c1"># ```</span>
        <span class="c1"># will not trigger this method multiple times</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">_setup_step</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="SSKernel.step"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.SSKernel.step">[docs]</a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">state</span></div>

<div class="viewcode-block" id="SSKernel.default_state"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.SSKernel.default_state">[docs]</a>    <span class="k">def</span> <span class="nf">default_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">default_state</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="S4"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.S4">[docs]</a><span class="k">class</span> <span class="nc">S4</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">d_model</span><span class="p">,</span>
        <span class="n">d_state</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
        <span class="n">l_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">bidirectional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="c1"># Arguments for position-wise feedforward components</span>
        <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;gelu&quot;</span><span class="p">,</span>
        <span class="n">postact</span><span class="o">=</span><span class="s2">&quot;glu&quot;</span><span class="p">,</span>
        <span class="n">hyper_act</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dropout</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">tie_dropout</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">bottleneck</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">gate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">transposed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="c1"># SSM Kernel arguments</span>
        <span class="o">**</span><span class="n">kernel_args</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize S4 module.</span>

<span class="sd">        d_state: the dimension of the state, also denoted by N</span>
<span class="sd">        l_max: the maximum kernel length, also denoted by L.</span>
<span class="sd">                Set l_max=None to always use a global kernel</span>
<span class="sd">        channels: can be interpreted as a number of &quot;heads&quot;;</span>
<span class="sd">                the SSM is a map from a 1-dim to C-dim sequence.</span>
<span class="sd">                It&#39;s not recommended to change this unless desperate for things to tune;</span>
<span class="sd">                instead, increase d_model for larger models</span>
<span class="sd">        bidirectional: if True, convolution kernel will be two-sided</span>

<span class="sd">        Position-wise feedforward components:</span>
<span class="sd">        --------------------</span>
<span class="sd">        activation: activation in between SS and FF</span>
<span class="sd">        postact: activation after FF</span>
<span class="sd">        hyper_act: use a &quot;hypernetwork&quot; multiplication (experimental)</span>
<span class="sd">        dropout: standard dropout argument. tie_dropout=True ties the dropout</span>
<span class="sd">                mask across the sequence length, emulating nn.Dropout1d</span>

<span class="sd">        Other arguments:</span>
<span class="sd">        --------------------</span>
<span class="sd">        transposed: choose backbone axis ordering of</span>
<span class="sd">                (B, L, H) (if False) or (B, H, L) (if True)</span>
<span class="sd">                [B=batch size, L=sequence length, H=hidden dimension]</span>
<span class="sd">        gate: add gated activation (GSS)</span>
<span class="sd">        bottleneck: reduce SSM dimension (GSS)</span>

<span class="sd">        See the class SSKernel for the kernel constructor which accepts kernel_args.</span>
<span class="sd">        Relevant options that are worth considering</span>
<span class="sd">        and tuning include &quot;mode&quot; + &quot;measure&quot;, &quot;dt_min&quot;, &quot;dt_max&quot;, &quot;lr&quot;</span>

<span class="sd">        Other options are all experimental and should not need to be configured</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Constructing S4 (H, N, L) = (</span><span class="si">{</span><span class="n">d_model</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">d_state</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">l_max</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span> <span class="o">=</span> <span class="n">d_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">d_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">d_state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">l_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bidirectional</span> <span class="o">=</span> <span class="n">bidirectional</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transposed</span> <span class="o">=</span> <span class="n">transposed</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gate</span> <span class="o">=</span> <span class="n">gate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bottleneck</span> <span class="o">=</span> <span class="n">bottleneck</span>

        <span class="k">if</span> <span class="n">bottleneck</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">//</span> <span class="n">bottleneck</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_linear</span> <span class="o">=</span> <span class="n">LinearActivation</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span>
                <span class="n">transposed</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">transposed</span><span class="p">,</span>
                <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">,</span>
                <span class="n">activate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">gate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_gate</span> <span class="o">=</span> <span class="n">LinearActivation</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span> <span class="o">*</span> <span class="n">gate</span><span class="p">,</span>
                <span class="n">transposed</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">transposed</span><span class="p">,</span>
                <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">,</span>
                <span class="n">activate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_gate</span> <span class="o">=</span> <span class="n">LinearActivation</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span> <span class="o">*</span> <span class="n">gate</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span><span class="p">,</span>
                <span class="n">transposed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transposed</span><span class="p">,</span>
                <span class="n">activation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">activate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># optional multiplicative modulation GLU-style</span>
        <span class="c1"># https://arxiv.org/abs/2002.05202</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyper</span> <span class="o">=</span> <span class="n">hyper_act</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyper</span><span class="p">:</span>
            <span class="n">channels</span> <span class="o">*=</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hyper_activation</span> <span class="o">=</span> <span class="n">Activation</span><span class="p">(</span><span class="n">hyper_act</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bidirectional</span><span class="p">:</span>
            <span class="n">channels</span> <span class="o">*=</span> <span class="mi">2</span>

        <span class="c1"># SSM Kernel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span> <span class="o">=</span> <span class="n">SSKernel</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span>
            <span class="n">N</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span>
            <span class="n">L</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span>
            <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kernel_args</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Pointwise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="n">Activation</span><span class="p">(</span><span class="n">activation</span><span class="p">)</span>
        <span class="n">dropout_fn</span> <span class="o">=</span> <span class="n">DropoutNd</span> <span class="k">if</span> <span class="n">tie_dropout</span> <span class="k">else</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">dropout_fn</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span> <span class="k">if</span> <span class="n">dropout</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
        <span class="c1"># position-wise output transform to mix features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_linear</span> <span class="o">=</span> <span class="n">LinearActivation</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate</span><span class="p">),</span>
            <span class="n">transposed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transposed</span><span class="p">,</span>
            <span class="n">activation</span><span class="o">=</span><span class="n">postact</span><span class="p">,</span>
            <span class="n">activate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="S4.forward"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.S4.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">lengths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Forward pass.</span>

<span class="sd">        u: (B H L) if self.transposed else (B L H)</span>
<span class="sd">        state: (H N) never needed unless you know what you&#39;re doing</span>

<span class="sd">        Returns: same shape as u</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">transposed</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Mask out padding tokens</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lengths</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lengths</span> <span class="o">!=</span> <span class="n">L</span><span class="p">:</span>
                <span class="n">lengths</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">lengths</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lengths</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">lengths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lengths</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lengths</span> <span class="o">=</span> <span class="n">lengths</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">lengths</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">lengths</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="ow">and</span> <span class="n">lengths</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>
            <span class="p">),</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;l:</span><span class="si">{</span><span class="n">lengths</span><span class="o">.</span><span class="n">ndim</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">lengths</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">u</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">lengths</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">lengths</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
                <span class="mf">1.0</span><span class="p">,</span>
                <span class="mf">0.0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">u</span> <span class="o">*</span> <span class="n">mask</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_gate</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottleneck</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_linear</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>

        <span class="c1"># Compute SS Kernel</span>
        <span class="n">L_kernel</span> <span class="o">=</span> <span class="n">L</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">/</span> <span class="n">rate</span><span class="p">))</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">k_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">(</span>
            <span class="n">L</span><span class="o">=</span><span class="n">L_kernel</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="n">rate</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">state</span>
        <span class="p">)</span>  <span class="c1"># (C H L) (B C H L)</span>

        <span class="c1"># Convolution</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bidirectional</span><span class="p">:</span>
            <span class="n">k0</span><span class="p">,</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">rearrange</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;(s c) h l -&gt; s c h l&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">))</span> <span class="o">+</span> <span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">k1</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">k_f</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">L_kernel</span> <span class="o">+</span> <span class="n">L</span><span class="p">)</span>  <span class="c1"># (C H L)</span>
        <span class="n">u_f</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">L_kernel</span> <span class="o">+</span> <span class="n">L</span><span class="p">)</span>  <span class="c1"># (B H L)</span>
        <span class="n">y_f</span> <span class="o">=</span> <span class="n">contract</span><span class="p">(</span><span class="s2">&quot;bhl,chl-&gt;bchl&quot;</span><span class="p">,</span> <span class="n">u_f</span><span class="p">,</span> <span class="n">k_f</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">y_f</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">L_kernel</span> <span class="o">+</span> <span class="n">L</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">L</span><span class="p">]</span>  <span class="c1"># (B C H L)</span>

        <span class="c1"># Compute D term in state space equation - essentially a skip connection</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">contract</span><span class="p">(</span><span class="s2">&quot;bhl,ch-&gt;bchl&quot;</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">)</span>

        <span class="c1"># Compute state update</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">bidirectional</span>
            <span class="p">),</span> <span class="s2">&quot;Bidirectional not supported with state forwarding&quot;</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">k_state</span>  <span class="c1">#</span>
            <span class="n">next_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">forward_state</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">next_state</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Optional hyper-network multiplication</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyper</span><span class="p">:</span>
            <span class="n">y</span><span class="p">,</span> <span class="n">yh</span> <span class="o">=</span> <span class="n">rearrange</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="s2">&quot;b (s c) h l -&gt; s b c h l&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyper_activation</span><span class="p">(</span><span class="n">yh</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span>

        <span class="c1"># Reshape to flatten channels</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">rearrange</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="s2">&quot;... c h l -&gt; ... (c h) l&quot;</span><span class="p">)</span>

        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">transposed</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_linear</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">transposed</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_gate</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">v</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">next_state</span></div>

<div class="viewcode-block" id="S4.setup_step"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.S4.setup_step">[docs]</a>    <span class="k">def</span> <span class="nf">setup_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">_setup_step</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="S4.step"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.S4.step">[docs]</a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Step one time step as a recurrent model.</span>

<span class="sd">        Intended to be used during validation.</span>

<span class="sd">        u: (B H)</span>
<span class="sd">        state: (B H N)</span>
<span class="sd">        Returns: output (B H), state (B H N)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">next_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>  <span class="c1"># (B C H)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">u</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">rearrange</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="s2">&quot;b c h -&gt; b (c h)&quot;</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transposed</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_linear</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_linear</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">next_state</span></div>

<div class="viewcode-block" id="S4.default_state"><a class="viewcode-back" href="../../../../_gen/espnet2.asr.html#espnet2.asr.state_spaces.s4.S4.default_state">[docs]</a>    <span class="k">def</span> <span class="nf">default_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">batch_shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># kernel is not a SequenceModule so it doesn&#39;t need to adhere to same interface</span>
        <span class="c1"># the kernel will know the device of its own parameters</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">default_state</span><span class="p">(</span><span class="o">*</span><span class="n">batch_shape</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">d_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, Shinji Watanabe.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>